language: cpp
matrix:
  include:
  - dist: trusty
    compiler: gcc
  - os: osx
    compiler: clang
install:
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; 
    then 
      sudo apt-get -qq update; 
      sudo apt-get install libwxgtk3.0-dev libwxgtk3.0-0 libgps-dev libglu1-mesa-dev libgtk2.0-dev libbz2-dev libtinyxml-dev; 
      sudo apt-get install libexpat1-dev libcairo2-dev; 
      sudo apt-get install rpm; 
    fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]]; 
  then 
    brew install cairo libexif xz libarchive;
    wget http://opencpn.navnux.org/build_deps/wx312_opencpn50_macos109.tar.xz; 
    tar xJf wx312_opencpn50_macos109.tar.xz -C /tmp; export PATH="/usr/local/opt/gettext/bin:$PATH";
    echo 'export PATH="/usr/local/opt/gettext/bin:$PATH"' >> ~/.bash_profile; 
    wget http://opencpn.navnux.org/build_deps/Packages.dmg;
    hdiutil attach Packages.dmg; 
    sudo installer -pkg "/Volumes/Packages 1.2.5/Install Packages.pkg" -target "/"; 
  fi
script:
- if [[ "${COVERITY_SCAN_BRANCH}" == 1 ]]; 
  then 
    echo "Don't build on coverty_scan branch."; 
    exit 0; 
  fi
- mkdir build && cd build
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; 
  then 
    cmake -DCMAKE_BUILD_TYPE=Release ../ && make -sj2 && sudo make package; 
  fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]]; 
  then 
    cmake -DwxWidgets_CONFIG_EXECUTABLE=/tmp/wx312_opencpn50_macos109/bin/wx-config -DwxWidgets_CONFIG_OPTIONS="--prefix=/tmp/wx312_opencpn50_macos109" -DCMAKE_INSTALL_PREFIX=/tmp/opencpn -DCMAKE_OSX_DEPLOYMENT_TARGET=10.9 .. && make -sj2 && make create-pkg; 
  fi
- ls -l;
notifications:
  email: false
git:
  depth: 10
before_install:
- if [ "$CXX" = "g++" ]; 
  then 
    export CXX="g++-6" CC="gcc-6";
  fi
- if [ "${#OAUTH_ACCESS_TOKEN}" != 0 ]; 
  then 
    (echo OAUTH_ACCESS_TOKEN=${OAUTH_ACCESS_TOKEN} > ~/.dropbox_uploader); 
  fi
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - gcc-6
    - g++-6
deploy:
  matrix:
  - provider: script
    file: "$TRAVIS_BUILD_DIR/build/*.{deb,rpm,dmg,pkg,txz,pkg.tar.xz}"
    script: if [ -f ~/.dropbox_uploader ] ; then echo "OSX"; if [ "$TRAVIS_OS_NAME"
      = "osx" ] ; then echo "upload pkg"; bash ../dropbox_uploader.sh upload $TRAVIS_BUILD_DIR/build/*.pkg
      / ; fi; echo "Linux"; if [ "$TRAVIS_OS_NAME" = "linux" ] ; then echo "upload
      rpm"; bash ../dropbox_uploader.sh upload $TRAVIS_BUILD_DIR/build/*.rpm /; echo
      "upload deb"; bash ../dropbox_uploader.sh upload $TRAVIS_BUILD_DIR/build/*.deb
      /; fi; fi
    skip_cleanup: true
    on: # Set Deploy conditions
      # Deploy only when tag is not specified
      tags: false
      # or this branch
      branch: master_1.5
      # and only when API token is set
      # condition: ""${#OAUTH_ACCESS_TOKEN} != 0 && $BUILD_TYPE = Release
      condition: "${#OAUTH_ACCESS_TOKEN} != 0"
  - provider: launchpad
    slug: "~jonsgough/opencpn-plugin-draw/+git/ocpn_draw_pi"
    oauth_token_secret:
      secure: IfEUz16VPprAn/N00bPI08Nm8JCJ17IVbQzm9L1Vm+LEI/ZCuk40gRyeAxLkQm0X8YFgPJbm5mUocDIgAmdzQYSOpCIaz+WRUNMuKJF8TaiuxBmz7vMLq8NTYMNyNnDR47l8McWOGI24VWCZDpSIwqr3vsa6r/6B2d1OnNlGJK38EdIokR+FeOv1MH7UBQJINgpirC1Jwb9Pbnu1i1/88pXhNuSGOKJq26wSNCOzqDDHTof2TtfJoDQXZg1HwV4xnHl28uAtFyZUc/JcoQmaGamHQhIISvL45uUISots0ulyMHW5SbsIDuOU0/bQKyf0mpfd9V0GDuSj1AdIImhTTtkOgIK7kDPTU1uv9NW2SsuoBHZzUc6MS8uRLWcleOMO4PW7L1xt/RxBxV6c/1QOJoXMqqCgLIu36WmLoGK9OQm5ixAgouL48iGDZgyNBqLDw7STnT2R70PzKfe08QAEuKn9V9vvAHR6hEk9oVs9lQIqp3jXkPpTUi9ikIIYOvbh6wZ0bU/Ca5NHCkbZl04xwCGlwEv1zlHjQTEXty6zlAWeEN3htfckkoRUhGhFAe4ZJsA7qEyl0aLreyqEj+yUIDxb0yOrMU+yB140H4wgU2IZAKfXWXbRninDNdtyXtUZDtnG7o+5DdBr+OAlz/3UpxLuEizTU7R4xamyqrfOaCU=
    oauth_token:
      secure: T4x4xON2lDkfn+8qjW23hQh7o8l+TyCyeCDqagxrCGBt/eK01AsGiGKk1xU/WZCOjwhf/QNkKLf0+cuy5C+xw+/2BAObUiMsw+ByWmqqtRj+iCrgj4yjB20KSBh6aKjrYv97ZH4rr2xB4/M/qI4z7/b/gh23Fcmucqm07fBubXKDT6sEJT9tWsh7IRfn3rOUBOzVOPVyabAY6zYI5EVKZ90eOm2Voj6oV1/Npn1nao0oWYAO1oG6PS+XTt712Ua/tUdgaXK2Kq5kOZwVufjeVbru7OeqOkqjloGQT6vXPNiiHuv/UcecnlPup2Zo3hGeZzPI0PjsGgXyD5MweOW7+IIvxbUJtjaz/MzzsojdahqCzM4xbsRN6MfrQtsoCTJuwebeqwUEOvY8qB2GrbCu2+0jdLeT4XWkVMQQ9AzljoiHCSJlnxHrmRj7JVo1OcBdgu4+QYvQCoKp+d0NnxXpeVgII7wmYyc3dmXhsCv7eACNg6fJHaxNSgc/95Rk2fbOsZlaYipdlQjXP3jAxR++eeJF3SOlh4hTMsnHTM3VyTF98M8yhUucRdPbGt9aykisRXruYe8h/ZqM19bOvW/DT7T6GMOR29lqetTpxyQ8nEC0NpEzGejPwCEtCyXnhdx2Y9tXofSlzvaz5yJ0oRvKxZsWVNIteep/UhaxkMciOZU=
    skip_cleanup: true
    on: # Set Deploy conditions
      # Deploy only when tag is not specified
      # tags: false
      # or this branch
      #branches:
      #   only:
      #     - master
      #     - master_1.5
      all_branches: true
      condition: "$TRAVIS_OS_NAME = linux"
      repo: jongough/ocpn_draw_pi
